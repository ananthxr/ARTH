# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Unity-based AR treasure hunt game that combines GPS location tracking with AR image recognition. The system allows teams to register, receive timed delays based on team numbers, follow GPS clues to locations, and use AR to find virtual treasures.

## Core Architecture

### Main Components

1. **TreasureHuntManager** (`TreasureHuntManager.cs`) - Core game logic controller
   - Manages team registration and wave-based timing system
   - Handles GPS proximity detection using Niantic Lightship AR
   - Controls UI state transitions between registration, timer, clue, and AR scan panels
   - Implements Haversine formula for distance calculations

2. **ClueARImageManager** (`ClueARImageManager.cs`) - AR image tracking system
   - Manages AR image detection and 3D object spawning
   - Maps reference images to treasure prefabs and clue indices
   - Handles AR tracking states and object visibility
   - Pre-instantiates AR objects for performance

3. **InventoryManager** (`InventoryManager.cs`) - Treasure collection tracking system
   - Manages collected treasure visualization and inventory UI
   - Tracks collected treasures using clue indices
   - Updates treasure images from grayed-out to full color when collected
   - Provides inventory panel with collection status and progress tracking

4. **FirebaseFetcher** (`FirebaseFetcher.cs`) - Firebase integration master script
   - Handles all Firebase API communications as singleton
   - Fetches team data from Firestore database using UID
   - Caches team data for other scripts to access
   - Manages score updates to Firebase (optional)
   - Provides event-driven architecture for Firebase operations

### Key Data Structures

- **TreasureLocation**: Contains clue text, latitude, longitude, and physical game configuration for each treasure
  - `hasPhysicalGame`: Boolean to enable physical games for specific clues
  - `physicalGameInstruction`: Text displayed after treasure collection
- **ClueARData**: Maps clue indices to AR reference images and 3D prefabs
- **TeamData**: Firebase team information structure
  - `teamNumber`: Sequential team number assigned by Firebase
  - `uid`: Unique identifier for Unity integration
  - `teamName`: Human-readable team name
  - `player1`/`player2`: Team member names
  - `email`: Team contact email
  - `score`: Current team score

### Technology Stack

- Unity 3D game engine
- AR Foundation for cross-platform AR capabilities
- Niantic Lightship AR for GPS/world positioning
- TextMeshPro for UI text rendering
- XR Interaction Toolkit for AR interactions

## Development Workflow

### Unity-Specific Commands

This is a Unity project, so development typically happens through the Unity Editor:

- **Build for Android**: File > Build Settings > Android > Build
- **Build for iOS**: File > Build Settings > iOS > Build and Run
- **Test in Play Mode**: Press Play button in Unity Editor
- **Scene Management**: Load `ARTH_IMP_V1.unity` for the main scene

### Key Files and Locations

- Main Scene: `Assets/ARTH_Implementation_V1/ARTH_IMP_V1.unity`
- Scripts: `Assets/ARTH_Implementation_V1/V1/Scripts V1/`
- AR Reference Images: `Assets/ARTH_Implementation_V1/V1/Reference_Library/`
- 3D Models: `Assets/Import/` (contains treasure prefabs)

## Architecture Patterns

### Team Assignment Logic (Updated for Firebase Integration)
Teams are now registered through web interface and fetched via Firebase:
- User enters UID (generated by web registration system)
- FirebaseFetcher retrieves team data including actual team number
- Team assignment calculated using Firebase team number:
  - `wave = (teamNumber - 1) / totalClues`
  - `clueIndex = (teamNumber - 1) % totalClues`
  - `delayMinutes = wave * 5`

### State Management
The system uses a centralized state machine pattern with Firebase integration:
1. Registration Panel → Team Verification Panel → Timer Panel → Clue Panel → AR Scan Panel
2. UID input fetches team data from Firebase
3. Team verification confirms team details before hunt begins
4. GPS proximity triggers transition from clue to AR mode
5. AR object spawning is tied to clue progression

### Performance Optimizations
- AR objects are pre-instantiated and toggled rather than created/destroyed
- Only the current active clue's AR content is displayed
- GPS tracking is activated only during active hunts

## Key Integrations

### Firebase Integration (NEW)
- Web-based team registration system stores team data in Firestore
- Unity app fetches team details using UID instead of manual team number entry
- API endpoints: `/api/team` for team data retrieval, `/api/update-score` for score updates
- FirebaseFetcher script manages all Firebase communications as master service
- Event-driven architecture allows multiple scripts to respond to Firebase data

### Niantic Lightship AR
- `ARWorldPositioningCameraHelper` provides GPS coordinates
- Requires proper Lightship SDK configuration
- Used for world-scale positioning and GPS tracking

### AR Foundation
- `ARTrackedImageManager` handles image detection
- `ARCameraManager` manages AR camera functionality
- Supports both ARCore (Android) and ARKit (iOS)

## Common Development Tasks

When modifying treasure locations:
1. Update the `treasureLocations` array in TreasureHuntManager
2. Ensure corresponding AR reference images exist in the Reference_Library
3. Configure matching ClueARData entries with proper clue indices

When adding new AR content:
1. Create/import 3D prefabs for treasures
2. Add reference images to the AR Reference Image Library
3. Configure ClueARData mappings in ClueARImageManager
4. Test AR tracking in device builds (not editor)

## Important Notes

- AR functionality requires device testing - Unity Editor simulation is limited
- GPS coordinates use double precision for accuracy
- Team numbering starts from 1, but array indices are 0-based
- The proximity threshold (default 10m) determines when GPS switches to AR mode
- Pre-instantiated AR objects improve performance but increase memory usage

## Recent Updates & Debugging

### Mobile Debug System (Latest)
Both TreasureHuntManager and ClueARImageManager now have mobile debug capabilities:
- Added `mobileDebugText` field (TMP_Text) for on-screen debugging
- All Debug.Log calls also output to mobile TextMeshPro component
- ClueARImageManager has detailed step-by-step AR spawning debug messages

### Critical Index Configuration
**IMPORTANT**: ClueARData array must use 0-based indices:
- First clue: `clueIndex = 0` (not 1)
- Second clue: `clueIndex = 1` (not 2)
- This matches the team assignment calculation: `clueIndex = (teamNumber - 1) % totalClues`

### Recent Fixes & Current System Behavior

#### Treasure Collection System (FIXED - August 2025)
**Issue**: Collected treasures would reappear when camera moved away and back to marker
**Solution**: 
- Added `collectedClueIndices` HashSet in ClueARImageManager to track collected treasures
- Modified `UpdateTrackedImage()` to check if treasure already collected before spawning
- Removed scale reset in `TreasureHuntManager.ShrinkAndCollectTreasure()` 
- Added `MarkTreasureAsCollected()` method called after collection
- **Result**: Once collected, treasures never respawn even if marker is detected again

#### Collect Button Visibility (FIXED - August 2025)
**Issue**: "Collect Treasure" button remained visible when camera moved away from marker
**Solution**:
- Modified tracking state logic from `else if` to `else` in `UpdateTrackedImage()`
- Button now hides for ANY non-tracking state (Limited, None, etc.)
- Added button hiding in `ClearAllARObjects()` method
- **Result**: Button only visible when AR object is actively tracking and visible

#### Physical Game System (ADDED - August 2025)
**Feature**: Optional physical games after treasure collection
**Implementation**:
- Added `hasPhysicalGame` and `physicalGameInstruction` fields to TreasureLocation
- Physical game text displays in congratulations panel below remaining clues count
- Only shows when `hasPhysicalGame = true` for the collected treasure
- Integrates seamlessly with existing treasure collection flow

#### Inventory System (ADDED - August 2025)
**Feature**: Visual treasure collection tracking and inventory management
**Implementation**:
- New `InventoryManager.cs` script manages collected treasure visualization
- `inventoryButton` provides access to inventory panel from clue/GPS tracking phases
- Treasure images transition from grayed-out to full color when collected
- Real-time collection status display showing "X/Y Treasures" collected
- **Button Visibility**: Hidden during registration, timer, and AR scanning; visible during hunting

#### Current System State
1. **AR Object Spawning**: Fully working with comprehensive debugging
2. **Start Hunt Button**: Properly disappears when clicked using `gameObject.SetActive(false)`
3. **GPS Status Messages**: WPS status checking temporarily disabled due to camera access issues
4. **Performance**: Update() method in ClueARImageManager optimized to run every 10 frames
5. **Treasure Collection**: Prevents duplicate collection and object respawning
6. **Collect Button**: Dynamically shows/hides based on AR tracking state
7. **Physical Games**: Display contextual physical game instructions after treasure collection
8. **Inventory System**: Real-time visual tracking of collected treasures with proper UI state management

### Debug Messages to Watch For
When AR objects aren't spawning, look for these step-by-step messages:
- `"STEP 1: Detected ImageName, State: Tracking"` - Image detected
- `"STEP 2 PASSED: AR object exists for ImageName"` - AR object found
- `"STEP 3 PASSED: Clue data exists for ImageName"` - Clue data found  
- `"STEP 4 FAILED: Clue X already collected"` - Treasure already collected (NEW)
- `"STEP 4 PASSED: Clue X matches active X"` - Index matches
- `"STEP 5: Trying to spawn AR object..."` - About to spawn
- `"SUCCESS! AR OBJECT SPAWNED!"` - Success
- `"STEP 5 FAILED: Tracking state not good enough: [State]"` - Lost tracking, button hidden

### Setup Checklist for New Clues
1. AR Reference Image Library contains the marker image
2. ClueARData array has entry with correct 0-based `clueIndex`
3. `referenceImageName` matches exact name in AR Reference Image Library (case-sensitive)
4. `treasurePrefab` is assigned to a 3D object
5. TreasureLocations array has corresponding entry at same index
6. **NEW**: Configure physical game settings in TreasureLocation if desired
7. **NEW**: Add corresponding treasure image to InventoryManager's `treasureItemImages` array
8. Mobile debug TextMeshPro assigned to both managers for testing

## Technical Implementation Details

### Treasure Collection Flow (Current Implementation)
1. **AR Detection**: `ClueARImageManager.UpdateTrackedImage()` detects marker
2. **Validation Chain**:
   - Check if AR object exists for detected image
   - Check if clue data exists for image
   - **NEW**: Check if treasure already collected (`collectedClueIndices.Contains()`)
   - Check if clue index matches currently active clue
3. **Object Spawning**: If all checks pass, AR object appears and collect button shows
4. **Collection Process**: 
   - User clicks collect button → `TreasureHuntManager.OnCollectTreasure()`
   - Object scales down to zero over 0.5 seconds
   - Object deactivated but scale NOT reset (prevents reuse)
   - `ClueARImageManager.MarkTreasureAsCollected()` called to prevent respawning
   - **NEW**: `InventoryManager.AddCollectedTreasure()` called to update inventory
   - Clue counter incremented, congrats panel shown with optional physical game

### Button Visibility Logic (Current Implementation)
- **Show Collect Button**: Only when `TrackingState.Tracking` and AR object is active
- **Hide Collect Button**: 
  - Any non-tracking state (Limited, None, etc.) 
  - When `ClearAllARObjects()` is called
  - When clue is already collected
  - When switching between clues/panels

- **Show Inventory Button**: Visible during clue hunting and GPS tracking phases
- **Hide Inventory Button**: 
  - During registration and timer panels
  - When AR scanning mode is active (collect button priority)
  - When congratulations panel is showing

### Key Methods & Their Purposes

#### TreasureHuntManager.cs
- `OnCollectTreasure(GameObject)`: Triggers shrink animation and marks as collected
- `ShrinkAndCollectTreasure(GameObject)`: Coroutine that shrinks object and handles collection
- `OnNextTreasure()`: Cycles to next clue, resets UI state
- `GetRemainingClues()`: Returns uncollected clue count
- **NEW**: `OnInventoryButtonClicked()`: Opens inventory panel via InventoryManager

#### ClueARImageManager.cs  
- `UpdateTrackedImage(ARTrackedImage)`: Main AR detection and spawning logic
- `SetActiveClue(int)`: Sets which clue index should spawn AR objects
- `MarkTreasureAsCollected(int)`: Prevents respawning of collected treasures
- `ClearAllARObjects()`: Hides all AR objects and collect button
- `EnableARTracking()` / `DisableARTracking()`: Controls AR system state

#### InventoryManager.cs (NEW)
- `OpenInventory()` / `CloseInventory()`: Show/hide inventory panel
- `AddCollectedTreasure(int)`: Mark treasure as collected and update visual
- `SetTreasureImageState(int, bool)`: Update treasure image appearance
- `UpdateInventoryDisplay()`: Refresh collection status and treasure states
- `GetCollectedCount()`: Returns number of collected treasures

### Data Persistence & State Management
- `collectedClueIndices`: HashSet tracking which treasures have been collected (ClueARImageManager)
- `currentActiveClueIndex`: Which clue should currently spawn AR objects
- `arObjects`: Dictionary of pre-instantiated GameObjects keyed by image name
- `cluesFound`: Counter in TreasureHuntManager for completion tracking
- **NEW**: `collectedTreasureIndices`: HashSet in InventoryManager tracking collected treasures for UI
- **NEW**: `treasureItemImages[]`: Array of UI Images representing each treasure in inventory

### Critical Architectural Decisions
1. **Pre-instantiation**: All AR objects created at Start() for performance
2. **State-based spawning**: Only current active clue can spawn AR objects
3. **Collection persistence**: Once collected, treasures cannot respawn
4. **Dynamic button management**: Collect button tied directly to AR object visibility
5. **Scale preservation**: Collected objects remain shrunk to indicate used state
6. **NEW**: **Dual collection tracking**: ClueARImageManager prevents respawning, InventoryManager handles UI
7. **NEW**: **Smart button prioritization**: Inventory button hides when collect button is active
8. **NEW**: **Contextual physical games**: Display only when enabled for specific treasures

## Unity Scene Setup Requirements

### Firebase Integration Setup (NEW)
1. **Registration Panel Updates**:
   - Change `teamNumberInput` to `uidInput` (TMP_InputField for UID entry)
   - Change `registerButton` to `fetchTeamDataButton`
   - Configure API base URL in FirebaseFetcher script

2. **Team Verification Panel** (NEW):
   - Create `teamVerificationPanel` GameObject
   - Add `teamDetailsText` (TextMeshPro for team name and email)
   - Add `teamMembersText` (TextMeshPro for player names)
   - Add `teamNumberDisplayText` (TextMeshPro for team number)
   - Add `verifyTeamButton` (Button to confirm team details)

3. **TreasureHuntManager Inspector Updates**:
   - Assign `firebaseFetcher` (FirebaseFetcher component or leave null for auto-detection)
   - Assign all new UI components listed above
   - Update button references to new naming scheme

### Inventory System Setup
1. **Create Inventory Panel** containing:
   - `treasureItemImages[]` array (size = number of clues)
   - `inventoryTitle` TextMeshPro component
   - `collectionStatusText` TextMeshPro component  
   - `closeInventoryButton` Button component

2. **TreasureHuntManager Inspector**:
   - Assign `inventoryButton` (Button)
   - Assign `inventoryManager` (InventoryManager component)
   - Assign `physicalGameText` (TextMeshPro in congrats panel)

3. **InventoryManager Inspector**:
   - Assign `inventoryPanel` (GameObject)
   - Assign all UI references listed above
   - Configure `collectedColor` and `unCollectedColor` with desired visual appearance

### Physical Game System Setup
1. **For each TreasureLocation**:
   - Check `hasPhysicalGame` if you want a physical activity
   - Enter instruction text in `physicalGameInstruction` field
   
2. **Congratulations Panel**:
   - Add `physicalGameText` TextMeshPro component below remaining clues text
   - Assign to TreasureHuntManager's `physicalGameText` field